# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ S3/R2 –¥–ª—è –º–µ–¥–∏–∞-–ø–∞–π–ø–ª–∞–π–Ω–∞

–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: Cloudflare R2

**–ü–æ—á–µ–º—É R2 –ª—É—á—à–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**
- ‚úÖ **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫** (–±–µ–∑ egress fees, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç S3)
- ‚úÖ **S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API** (—Ç–æ—Ç –∂–µ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ **–î–µ—à–µ–≤–ª–µ**: $0.015/GB —Ö—Ä–∞–Ω–µ–Ω–∏—è vs $0.023/GB —É S3
- ‚úÖ **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π CDN** —á–µ—Ä–µ–∑ Cloudflare
- ‚úÖ **–†–æ—Å—Å–∏–π—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** - –æ—Ç–ª–∏—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —á–µ—Ä–µ–∑ Cloudflare

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare R2

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ R2 Bucket

1. **–ó–∞–π–¥–∏ –Ω–∞ Cloudflare Dashboard**
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ https://dash.cloudflare.com
   - –õ–æ–≥–∏–Ω (–µ—Å–ª–∏ –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)

2. **–û—Ç–∫—Ä–æ–π R2 —Ä–∞–∑–¥–µ–ª**
   ```
   Cloudflare Dashboard ‚Üí R2 ‚Üí Create bucket
   ```

3. **–°–æ–∑–¥–∞–π bucket**
   ```
   Bucket name: va-pc-media (–∏–ª–∏ –ª—é–±–æ–µ –∏–º—è)
   Location: Automatic (–∏–ª–∏ –≤—ã–±–µ—Ä–∏ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–≥–∏–æ–Ω)
   ```

   –ù–∞–∂–º–∏ **Create bucket**

### –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ API credentials

1. **–í R2 —Ä–∞–∑–¥–µ–ª–µ –Ω–∞–∂–º–∏ "Manage R2 API Tokens"**
   ```
   R2 ‚Üí Manage R2 API Tokens ‚Üí Create API token
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞**
   ```
   Token name: va-pc-media-token

   Permissions:
   ‚úÖ Object Read & Write (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏/—Å–∫–∞—á–∏–≤–∞–Ω–∏—è)

   TTL: Forever (–∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏)

   Specify bucket(s): va-pc-media (–≤—ã–±–µ—Ä–∏ —Å–≤–æ–π bucket)
   ```

3. **–°–æ–∑–¥–∞–π —Ç–æ–∫–µ–Ω –∏ –°–û–•–†–ê–ù–ò credentials**

   –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—ã –ø–æ–ª—É—á–∏—à—å:
   ```
   Access Key ID: <–¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞>
   Secret Access Key: <—Å–µ–∫—Ä–µ—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞>

   Jurisdiction-specific endpoint for S3 clients:
   https://<account-id>.r2.cloudflarestorage.com
   ```

   ‚ö†Ô∏è **–í–ê–ñ–ù–û**: Secret Access Key –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –û–î–ò–ù –†–ê–ó! –°–∫–æ–ø–∏—Ä—É–π –µ–≥–æ —Å—Ä–∞–∑—É.

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS

1. **–ü–µ—Ä–µ–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ bucket**
   ```
   R2 ‚Üí —Ç–≤–æ–π bucket (va-pc-media) ‚Üí Settings ‚Üí CORS Policy
   ```

2. **–î–æ–±–∞–≤—å CORS –ø—Ä–∞–≤–∏–ª–æ**

   –ù–∞–∂–º–∏ **Add CORS policy** –∏ –≤—Å—Ç–∞–≤—å:

   ```json
   [
     {
       "AllowedOrigins": [
         "http://localhost:3000",
         "https://your-domain.com",
         "https://*.your-domain.com"
       ],
       "AllowedMethods": [
         "GET",
         "PUT",
         "POST",
         "DELETE",
         "HEAD"
       ],
       "AllowedHeaders": [
         "*"
       ],
       "ExposeHeaders": [
         "ETag"
       ],
       "MaxAgeSeconds": 3600
     }
   ]
   ```

   –ó–∞–º–µ–Ω–∏ `your-domain.com` –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω.

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Public CDN (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö bucket –Ω–∞–π–¥–∏ "Public access"**
   ```
   R2 ‚Üí va-pc-media ‚Üí Settings ‚Üí Public access
   ```

2. **–í–∫–ª—é—á–∏ Custom Domains**
   ```
   Connect Domain ‚Üí cdn.va-pc.ru (–∏–ª–∏ —Ç–≤–æ–π –ø–æ–¥–¥–æ–º–µ–Ω)
   ```

3. **DNS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—Å—è** —á–µ—Ä–µ–∑ Cloudflare

   Cloudflare —Å–æ–∑–¥–∞—Å—Ç CNAME –∑–∞–ø–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –¥–æ–º–µ–Ω —É–∂–µ –Ω–∞ Cloudflare.

### –®–∞–≥ 5: –î–æ–±–∞–≤—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `.env.local` –≤ `apps/miniapp/`:

```bash
# Cloudflare R2 Configuration
S3_BUCKET_NAME=va-pc-media
S3_REGION=auto
S3_ENDPOINT=https://<—Ç–≤–æ–π-account-id>.r2.cloudflarestorage.com
S3_ACCESS_KEY_ID=<—Ç–≤–æ–π Access Key ID>
S3_SECRET_ACCESS_KEY=<—Ç–≤–æ–π Secret Access Key>
CDN_BASE_URL=https://cdn.va-pc.ru
```

**–ì–¥–µ –≤–∑—è—Ç—å account-id:**
- –û–Ω —É–∫–∞–∑–∞–Ω –≤ endpoint URL, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø–æ–ª—É—á–∏–ª –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ API —Ç–æ–∫–µ–Ω–∞
- –ò–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–∏ –≤ URL –±—Ä–∞—É–∑–µ—Ä–∞: `dash.cloudflare.com/<account-id>/r2/`

---

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: AWS S3

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ S3 Bucket

1. **–ó–∞–π–¥–∏ –≤ AWS Console**
   - https://console.aws.amazon.com/s3

2. **Create bucket**
   ```
   Bucket name: va-pc-media
   Region: eu-central-1 (Frankfurt - –±–ª–∏–∂–µ –∫ –†–æ—Å—Å–∏–∏)

   Object Ownership: ACLs disabled (recommended)

   Block Public Access:
   ‚úÖ Block all public access (–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º signed URLs)

   Versioning: Disable

   Encryption: Enable (SSE-S3)
   ```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IAM User

1. **–°–æ–∑–¥–∞–π IAM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   ```
   IAM ‚Üí Users ‚Üí Add users

   User name: va-pc-media-uploader
   Access type: Programmatic access
   ```

2. **–î–æ–±–∞–≤—å –ø–æ–ª–∏—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–∞**

   Attach existing policies directly ‚Üí Create policy ‚Üí JSON:

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "s3:PutObject",
           "s3:GetObject",
           "s3:DeleteObject",
           "s3:ListBucket"
         ],
         "Resource": [
           "arn:aws:s3:::va-pc-media",
           "arn:aws:s3:::va-pc-media/*"
         ]
       }
     ]
   }
   ```

   Policy name: `va-pc-media-policy`

3. **–°–æ—Ö—Ä–∞–Ω–∏ credentials**
   ```
   Access key ID: <–∫–ª—é—á>
   Secret access key: <—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á>
   ```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –¥–ª—è S3

1. **S3 ‚Üí va-pc-media ‚Üí Permissions ‚Üí CORS**

   ```json
   [
     {
       "AllowedHeaders": ["*"],
       "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
       "AllowedOrigins": [
         "http://localhost:3000",
         "https://your-domain.com"
       ],
       "ExposeHeaders": ["ETag"],
       "MaxAgeSeconds": 3600
     }
   ]
   ```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CloudFront CDN (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **CloudFront ‚Üí Create Distribution**
   ```
   Origin Domain: va-pc-media.s3.eu-central-1.amazonaws.com
   Origin Path: (–ø—É—Å—Ç–æ)

   Viewer Protocol Policy: Redirect HTTP to HTTPS

   Compress Objects Automatically: Yes

   Price Class: Use Only North America and Europe
   ```

2. **–ü–æ–ª—É—á–∏ CloudFront URL**
   ```
   Distribution Domain Name: d123abc456def.cloudfront.net
   ```

### –®–∞–≥ 5: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è S3

```bash
# AWS S3 Configuration
S3_BUCKET_NAME=va-pc-media
S3_REGION=eu-central-1
S3_ENDPOINT=  # –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ S3
S3_ACCESS_KEY_ID=<—Ç–≤–æ–π IAM Access Key>
S3_SECRET_ACCESS_KEY=<—Ç–≤–æ–π IAM Secret Key>
CDN_BASE_URL=https://d123abc456def.cloudfront.net
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
cd apps/miniapp

# –£—Å—Ç–∞–Ω–æ–≤–∏ tsx –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
pnpm add -D tsx

# –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
pnpm tsx scripts/test-s3-connection.ts
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
1. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ bucket
2. ‚úÖ –ó–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
3. ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
4. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞

–ï—Å–ª–∏ —É–≤–∏–¥–∏—à—å `üéâ All tests passed!` - –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

---

## üéØ –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
# 1. –°–æ–∑–¥–∞–π .env.local —Ñ–∞–π–ª
cp .env.example .env.local

# 2. –ó–∞–ø–æ–ª–Ω–∏ credentials (–∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ Cloudflare R2 –∏–ª–∏ AWS)
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π .env.local:

S3_BUCKET_NAME=va-pc-media
S3_REGION=auto
S3_ENDPOINT=https://YOUR-ACCOUNT-ID.r2.cloudflarestorage.com
S3_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID
S3_SECRET_ACCESS_KEY=YOUR_SECRET_ACCESS_KEY
CDN_BASE_URL=https://cdn.va-pc.ru

# 3. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
pnpm tsx scripts/test-s3-connection.ts

# 4. –ï—Å–ª–∏ —Ç–µ—Å—Ç –ø—Ä–æ—à–µ–ª - –∑–∞–ø—É—Å—Ç–∏ Prisma generate
pnpm db:generate

# 5. –ì–æ—Ç–æ–≤–æ! –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å MediaUploader
pnpm dev
# –û—Ç–∫—Ä–æ–π http://localhost:3000/admin/test/media-uploader
```

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å (–¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏)

### Cloudflare R2:
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: $0.015/GB –≤ –º–µ—Å—è—Ü
- **–û–ø–µ—Ä–∞—Ü–∏–∏ Class A** (PUT, POST): $4.50 –∑–∞ 1M –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û–ø–µ—Ä–∞—Ü–∏–∏ Class B** (GET, HEAD): $0.36 –∑–∞ 1M –∑–∞–ø—Ä–æ—Å–æ–≤
- **–¢—Ä–∞—Ñ–∏–∫**: **–ë–ï–°–ü–õ–ê–¢–ù–û** üéâ

**–ü—Ä–∏–º–µ—Ä**: 100GB –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π + 100K –∑–∞–≥—Ä—É–∑–æ–∫/–º–µ—Å—è—Ü = ~$2/–º–µ—Å—è—Ü

### AWS S3:
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: $0.023/GB –≤ –º–µ—Å—è—Ü
- **–¢—Ä–∞—Ñ–∏–∫**: $0.09/GB (–¥–æ—Ä–æ–≥–æ!)
- **–û–ø–µ—Ä–∞—Ü–∏–∏**: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ R2

**–¢–æ—Ç –∂–µ –ø—Ä–∏–º–µ—Ä**: 100GB + 100K –∑–∞–≥—Ä—É–∑–æ–∫ + 500GB —Ç—Ä–∞—Ñ–∏–∫–∞ = ~$50/–º–µ—Å—è—Ü

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ R2 vs S3

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Cloudflare R2 | AWS S3 |
|----------|---------------|--------|
| –•—Ä–∞–Ω–µ–Ω–∏–µ (GB/–º–µ—Å) | $0.015 | $0.023 |
| –¢—Ä–∞—Ñ–∏–∫ (egress) | **–ë–ï–°–ü–õ–ê–¢–ù–û** | $0.09/GB |
| API —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | S3 API | S3 API |
| CDN | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π (Cloudflare) | CloudFront (–æ—Ç–¥–µ–ª—å–Ω–æ) |
| –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∏—Ä | 10GB —Ö—Ä–∞–Ω–µ–Ω–∏—è | 5GB –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤ |
| –†–µ–≥–∏–æ–Ω—ã | Auto –∏–ª–∏ –≤—ã–±–æ—Ä | –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ |
| –°–∫–æ—Ä–æ—Å—Ç—å –≤ –†–§ | –û—Ç–ª–∏—á–Ω–∞—è (Cloudflare) | –°—Ä–µ–¥–Ω—è—è |

**–í—ã–≤–æ–¥**: R2 –≤—ã–≥–æ–¥–Ω–µ–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –±–æ–ª—å—à–∏–º —Ç—Ä–∞—Ñ–∏–∫–æ–º.

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### Q: –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ (S3 –∏ R2) –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?
A: –î–∞, –Ω–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–≤—É–º—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—é –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω.

### Q: –ö–∞–∫ –ø–æ–º–µ–Ω—è—Ç—å bucket –ø–æ–∑–∂–µ?
A: –ü—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–∏ `S3_BUCKET_NAME` –≤ `.env.local` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä. –ù–æ —Ñ–∞–π–ª—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Å—Ç–∞—Ä–æ–º bucket - –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è.

### Q: –ù—É–∂–µ–Ω –ª–∏ –º–Ω–µ CDN –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏?
A: –ù–µ—Ç, –¥–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ S3/R2 URLs. CDN –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥–∞.

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç?
A: –ü—Ä–æ–≤–µ—Ä—å:
1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å credentials (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é Secret Key?)
2. CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ bucket
3. API —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ Object Read & Write
4. Bucket name –±–µ–∑ –æ–ø–µ—á–∞—Ç–æ–∫
5. Endpoint URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (–¥–ª—è R2 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å .r2.cloudflarestorage.com)

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ?
A: –î–∞, –ª—é–±–æ–µ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ: MinIO, DigitalOcean Spaces, Backblaze B2, Wasabi –∏ —Ç.–¥. –ü—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–∏ endpoint.

### Q: –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å credentials?
A:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π `.env.local` (–ù–ï –∫–æ–º–º–∏—Ç—å –≤ git!)
- ‚úÖ –í production –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (Vercel, Railway –∏ —Ç.–¥.)
- ‚úÖ –†–æ—Ç–∏—Ä—É–π —Ç–æ–∫–µ–Ω—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π bucket)

### Q: –ß—Ç–æ —Ç–∞–∫–æ–µ signed URLs –∏ –∑–∞—á–µ–º –æ–Ω–∏?
A: Signed URLs - —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ —Å –ø–æ–¥–ø–∏—Å—å—é, –∫–æ—Ç–æ—Ä—ã–µ:
- –†–∞–±–æ—Ç–∞—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (—É –Ω–∞—Å 10 –º–∏–Ω—É—Ç)
- –ü–æ–∑–≤–æ–ª—è—é—Ç –∫–ª–∏–µ–Ω—Ç—É –∑–∞–≥—Ä—É–∂–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ S3 –±–µ–∑ –ø—Ä–æ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã - –ø–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è S3/R2
- –≠–∫–æ–Ω–æ–º—è—Ç —Ç—Ä–∞—Ñ–∏–∫ —Å–µ—Ä–≤–µ—Ä–∞

### Q: –°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞?
A: –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞:
- 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º–∏: ~2-3 MB
- 1000 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ~2-3 GB
- 10000 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ~20-30 GB

–ù–∞—á–Ω–∏ —Å 50-100GB - —ç—Ç–æ–≥–æ —Ö–≤–∞—Ç–∏—Ç –Ω–∞–¥–æ–ª–≥–æ.

---

## üîß –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### Lifecycle Rules (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤)

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫:

1. **R2 ‚Üí Settings ‚Üí Lifecycle Rules**
2. **Add Rule**:
   ```
   Rule name: Delete temp uploads
   Prefix: upload_
   Expiration: 1 day
   ```

–≠—Ç–æ —É–¥–∞–ª–∏—Ç –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### Cloudflare R2:
```
Dashboard ‚Üí R2 ‚Üí Analytics
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- Storage usage
- Request counts (Class A/B)
- Bandwidth (—Ö–æ—Ç—å –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)

#### AWS S3:
```
CloudWatch ‚Üí Metrics ‚Üí S3
```
–ù–∞—Å—Ç—Ä–æ–π –∞–ª–µ—Ä—Ç—ã –Ω–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–≤–æ—Ç.

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

**–í–∞–∂–Ω–æ**: –ù–∞—Å—Ç—Ä–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–î–ª—è R2:
```
R2 ‚Üí Settings ‚Üí Replication
Target: –¥—Ä—É–≥–æ–π bucket –∏–ª–∏ S3
```

–î–ª—è S3:
```
S3 ‚Üí Management ‚Üí Replication rules
```

---

## üöÄ Production Checklist

–ü–µ—Ä–µ–¥ –≤—ã–∫–∞—Ç–∫–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω –ø—Ä–æ–≤–µ—Ä—å:

- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏
- [ ] API —Ç–æ–∫–µ–Ω/IAM user –∏–º–µ–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
- [ ] CDN –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Cache headers –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (immutable –¥–ª—è derivatives)
- [ ] Lifecycle rules –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (–¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- [ ] .env.local –ù–ï –≤ git (–ø—Ä–æ–≤–µ—Ä—å .gitignore)
- [ ] Production credentials –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- [ ] –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
- [ ] –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Cloudflare R2 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://developers.cloudflare.com/r2/)
- [AWS S3 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.aws.amazon.com/s3/)
- [S3 API Reference](https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html)
- [CORS Configuration](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)

---

## üí¨ –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ó–∞–ø—É—Å—Ç–∏ `pnpm tsx scripts/test-s3-connection.ts` –∏ –ø–æ–∫–∞–∂–∏ –≤—ã–≤–æ–¥
2. –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `echo $S3_ENDPOINT`
3. –ü—Ä–æ–≤–µ—Ä—å CORS –≤ bucket –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
4. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ API —Ç–æ–∫–µ–Ω–∞/IAM user

–£–¥–∞—á–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π! üöÄ
